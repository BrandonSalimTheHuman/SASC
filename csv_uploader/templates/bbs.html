<!DOCTYPE html>
<html>
  <head>
    <title>BINUS Student BBS Calculations</title>
    <!-- Include Bootstrap CSS for styling -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Include DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css"
    />
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <!-- Include Sheet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Include Excel JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../static/css/styles.css" />
  </head>
  <body>
    <div class="container-fluid mt-5">
      <div class="row justify-content-center">
        <div class="col-12">
          <div class="card shadow-sm" id="main-card">
            <div class="card-body">
              <!-- Dashboard button and title-->
              <a href="/" class="btn btn-secondary mb-3">Back</a>
              <h1 class="card-title mb-4">BINUS - BBS Calculations</h1>

              <!-- Button to upload a new file -->
              <h4>Upload Data</h4>
              <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                  <input
                    type="file"
                    class="form-control-file"
                    id="fileInput"
                    name="file"
                  />
                </div>
                <button
                  type="button"
                  class="btn btn-primary"
                  onclick="uploadFile()"
                >
                  Upload
                </button>
              </form>

              <!-- Progress bar for upload -->
              <div
                class="progress mt-3"
                id="uploadProgressBarContainer"
                style="display: none"
              >
                <div
                  class="progress-bar"
                  id="uploadProgressBar"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  0%
                </div>
              </div>

              <hr />

              <!-- Shows the currently loaded file's year, semester, and period -->
              <h5 class="mb-4" id="loadedYear">Currently loaded year:</h5>
              <h5 class="mt-4" id="loadedSemester">
                Currently loaded semester:
              </h5>
              <h5 class="mt-4" id="loadedPeriod">Currently loaded period:</h5>

              <!-- Button to display DataFrame -->
              <button
                id="toggleDataFrameButton"
                class="btn btn-secondary mt-3"
                onclick="toggleDataFrame()"
              >
                Display DataFrame
              </button>

              <!-- Button to calculate tables -->
              <button
                id="calculateColumnsButton"
                class="btn btn-secondary mt-3"
                onclick="calculateColumns()"
              >
                Calculate columns for extended schedules
              </button>

              <!-- Button to calculate tables -->
              <button
                id="calculateStudentListButton"
                class="btn btn-secondary mt-3"
                onclick="calculateStudentList()"
                style="display: none"
              >
                Calculate list of students that need extension
              </button>

              <!-- Display DataFrame -->
              <div id="dataFrameContainer" class="mt-4" style="display: none">
                <div class="table-responsive">
                  <!-- Add table-striped class to make rows striped -->
                  <table
                    id="dataFrameTable"
                    class="table table-striped table-bordered"
                  >
                    <thead id="dataFrameTableHead"></thead>
                    <tfoot id="dataFrameTableFoot"></tfoot>
                  </table>
                </div>
              </div>

              <div
                id="calculatedTableContainer"
                class="mt-4"
                style="display: none"
              >
                <div class="table-responsive">
                  <table
                    id="calculatedTable"
                    class="table table-striped table-bordered"
                  ></table>
                </div>
              </div>

              <button
                id="toggleCalculatedTableButton"
                class="btn btn-secondary mt-3"
                onclick="toggleCalculatedTable()"
                style="display: none"
              >
                Display Calculated Columns Table
              </button>

              <!-- Display GROUPBY NIM and Course Table -->
              <div id="studentListContainer" class="mt-4" style="display: none">
                <div class="table-responsive">
                  <table
                    id="studentListTable"
                    class="table table-striped table-bordered"
                  ></table>
                </div>
              </div>

              <button
                id="toggleStudentListButton"
                class="btn btn-secondary mt-3"
                onclick="toggleStudentListTable()"
                style="display: none"
              >
                Display Student List Table
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Run on start or reload
      $(document).ready(function () {
        // Check if some files have already been loaded / calculated in this session
        $.ajax({
          url: '/search_bbs_file',
          type: 'GET',
          success: function (response) {
            let extendedExists = response.extended;
            let studentExists = response.student;

            // Toggle 'show' buttons for the aggregated tables
            if (extendedExists) {
              $('#toggleCalculatedTableButton').show();
              $('#calculateStudentListButton').show();
            }
            if (studentExists) {
              $('#toggleStudentListButton').show();
            }
            // Extract the period, semester type and year from the main file
            if (response.main) {
              let match = response.main.match(
                /^bbs_data_(\d{4})_(\d{1})_(\d{1})\.csv$/
              );
              if (match) {
                let year = match[1];
                let semester = match[2];
                let period = match[3];

                $('#loadedYear').text(`Currently loaded year: ${year}`);
                $('#loadedSemester').text(
                  `Currently loaded semester: ${semester}`
                );
                $('#loadedPeriod').text(`Currently loaded period: ${period}`);

                // Extracting year, semeseter, period
                const shortenedYear = parseInt(year) % 100;
                window.stringToMatch = `${shortenedYear}.${parseInt(
                  semester
                )}${parseInt(period)}`;
                window.stringToMatchPDPT = `${shortenedYear}.${parseInt(
                  semester
                )}0`;
              }
            }
          },
          error: function () {
            $('#fileStatus').text('Error checking uploaded files.');
          },
        });

        // Custom filtering
        $.fn.dataTable.ext.search.push(function (
          settings,
          data,
          dataIndex,
          rowNode
        ) {
          // Only applies to calculatedTable
          if (settings.nTable.id === 'calculatedTable' && window.yellowFilter) {
            // For every row, only return true (show it) if any column from 12-17 matches their respective date
            const $row = $(rowNode);
            const hasYellow =
              data[12] == window.stringToMatch ||
              data[14] == window.stringToMatch ||
              data[16] == window.stringToMatch ||
              data[13] == window.stringToMatchPDPT ||
              data[15] == window.stringToMatchPDPT ||
              data[17] == window.stringToMatchPDPT;

            if (!hasYellow) return false;
          }

          // Assumes valid to start, then if something doesn't match, it'll be changed to false
          let isValid = true;
          let tableId = `#${settings.nTable.id}`;

          // For every table with operators
          $(`${tableId} .filters th`).each(function (index) {
            if (!isValid) return;

            let input = $(this).find('.filter-value');
            let operator = $(this).find('.filter-operator').val();
            let filterValue = input.val();

            if (filterValue !== undefined && filterValue !== '') {
              if (data[index] === '-') {
                isValid = false;
                return false;
              }

              let cellValue = parseFloat(data[index]);
              if (operator === '>=' && cellValue < parseFloat(filterValue)) {
                isValid = false;
              } else if (
                operator === '<=' &&
                cellValue > parseFloat(filterValue)
              ) {
                isValid = false;
              } else if (
                operator === '<' &&
                cellValue >= parseFloat(filterValue)
              ) {
                isValid = false;
              } else if (
                operator === '>' &&
                cellValue <= parseFloat(filterValue)
              ) {
                isValid = false;
              }
            }
          });

          return isValid;
        });
      });

      // Function to upload a file, with the progress bar
      function uploadFile() {
        var form = $('#uploadForm')[0];
        var formData = new FormData(form);
        var xhr = new XMLHttpRequest();
        var uploadProgressBarContainer = $('#uploadProgressBarContainer');
        var uploadProgressBar = $('#uploadProgressBar');

        xhr.upload.addEventListener('progress', function (e) {
          if (e.lengthComputable) {
            var percentComplete = (e.loaded / e.total) * 100;
            uploadProgressBar.width(percentComplete + '%');
            uploadProgressBar.attr('aria-valuenow', percentComplete);
            uploadProgressBar.text(Math.round(percentComplete) + '%');
          }
        });

        xhr.addEventListener('load', function () {
          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            if (response.success) {
              $('#loadedYear').text(
                `Currently loaded year: ${response.fileYear}`
              );
              $('#loadedSemester').text(
                `Currently loaded semester: ${response.fileSemester}`
              );
              $('#loadedPeriod').text(
                `Currently loaded period: ${response.filePeriod}`
              );

              const shortenedYear = parseInt(response.fileYear) % 100;
              window.stringToMatch = `${shortenedYear}.${parseInt(
                response.fileSemester
              )}${parseInt(response.filePeriod)}`;
              window.stringToMatchPDPT = `${shortenedYear}.${parseInt(
                response.fileSemester
              )}0`;

              uploadProgressBar.text('Upload complete');
              setTimeout(function () {
                alert(response.success);
                uploadProgressBarContainer.hide();
              }, 500); // Delay to show the completed progress bar before hiding
            } else {
              alert(response.error);
              uploadProgressBarContainer.hide();
            }
          } else {
            alert('Error uploading file');
            uploadProgressBarContainer.hide();
          }
        });

        xhr.open('POST', '/upload_bbs', true);
        xhr.send(formData);

        uploadProgressBarContainer.show();
      }

      // Togggles the original dataframe
      function toggleDataFrame() {
        var button = $('#toggleDataFrameButton');
        var dataFrameContainer = $('#dataFrameContainer');

        if (dataFrameContainer.is(':visible')) {
          // Hide the DataFrame and change button text to "Display DataFrame"
          dataFrameContainer.hide();
          button.text('Display DataFrame');
        } else {
          // Show the DataFrame and change button text to "Hide DataFrame"
          $.ajax({
            type: 'POST',
            url: '/get_bbs',
            contentType: 'application/json',
            success: function (response) {
              if (response.data) {
                if ($.fn.DataTable.isDataTable('#dataFrameTable')) {
                  $('#dataFrameTable').DataTable().destroy();
                  $('#dataFrameTable').empty();
                }

                const tableHead = $('#dataFrameTableHead');
                const tableFoot = $('#dataFrameTableFoot');
                const data = $(response.data);

                const headers = data.find('thead th');
                let headerHtml = '<tr>';
                headers.each(function () {
                  headerHtml += `<th>${$(this).text()}</th>`;
                });
                headerHtml += '</tr>';

                tableHead.html(headerHtml);

                $('#dataFrameTable').html(data.html());

                // Row for filters
                $('#dataFrameTable thead').append('<tr class="filters"></tr>');

                // Add inputs
                $('#dataFrameTable thead tr:eq(0) th').each(function (index) {
                  // Check if it's a percentage column
                  if (index === 11) {
                    $('#dataFrameTable .filters').append(`
                      <th style='width: 20%;'>
                        <select class="filter-operator">
                          <option value=">=">>=</option>
                          <option value=">">></option>
                          <option value="<="><=</option>
                          <option value="<"><</option>
                        </select>
                        <input type="number" class="filter-value" placeholder="Search..." style="width:100%">
                      </th>
                  `);
                  } else {
                    $('#dataFrameTable .filters').append(
                      `<th><input type="text" placeholder="Search..." style="width:100%"/></th>`
                    );
                  }
                });

                let table = $('#dataFrameTable').DataTable({
                  pageLength: 10,
                  lengthMenu: [
                    [10, 25, 50, 100],
                    [10, 25, 50, 100],
                  ],
                  responsive: true,
                  autoWidth: false,
                  searching: true,
                  ordering: true,
                  orderCellsTop: true,
                  fixedHeader: true,
                  dom: 'Blfrtip',
                  buttons: [
                    {
                      text: 'Export to Excel',
                      action: function () {
                        exportStyledTableToExcel('BBS Main Data Table');
                      },
                    },
                  ],

                  initComplete: function () {
                    //Bind listener to automatically filter
                    this.api()
                      .columns()
                      .every(function () {
                        var column = this;
                        var index = column.index();

                        if (index === 11) return;
                        $(
                          'input',
                          $('#dataFrameTable .filters th').eq(column.index())
                        ).on('keyup change', function () {
                          column.search($(this).val()).draw();
                        });
                      });

                    // Apply percentage filters
                    $('#dataFrameTable .filters').on(
                      'keyup change',
                      'input.filter-value, select.filter-operator',
                      function () {
                        table.draw();
                      }
                    );
                  },
                });

                dataTableInitialized = true;
                dataFrameContainer.show();
                button.text('Hide DataFrame');
              } else {
                alert(response.error);
              }
            },
            error: function () {
              alert('Error fetching DataFrame');
            },
          });
        }
      }

      // Function to calculate both tables
      function calculateColumns() {
        $.ajax({
          type: 'POST',
          url: '/calculate_extended_columns',
          success: function (response) {
            if (response.success) {
              // Display an alert when the calculation is completed
              alert('Calculation complete');

              // Show the button to display the table, and allow calculation of student list
              $('#toggleCalculatedTableButton').show();
              $('#calculateStudentListButton').show();
            } else {
              alert('Error: ' + response.error);
            }
          },
          error: function () {
            alert('Error occurred while aggregating by NIM and COURSE NAME.');
          },
        });
      }

      // Function to calculate both tables
      function calculateStudentList() {
        // Extracting year, semeseter, period
        const loadedYear = parseInt($('#loadedYear').text().match(/\d{4}/)[0]);
        const loadedSemester = parseInt(
          $('#loadedSemester').text().match(/\d+/)[0]
        );
        const loadedPeriod = parseInt(
          $('#loadedPeriod').text().match(/\d+/)[0]
        );

        const shortenedYear = loadedYear % 100;

        $.ajax({
          type: 'POST',
          url: '/calculate_student_list',
          contentType: 'application/json',
          data: JSON.stringify({
            year: shortenedYear,
            semester: loadedSemester,
            period: loadedPeriod,
          }),
          success: function (response) {
            if (response.success) {
              // Display an alert when the calculation is completed
              alert('Calculation complete');

              // Set global variable for yellow filter
              window.yellowFilter = false;

              // Show the button to display the tables
              $('#toggleStudentListButton').show();
            } else {
              alert('Error: ' + response.error);
            }
          },
          error: function () {
            alert('Error occurred while calculating student list.');
          },
        });
      }

      // Show the GROUPBY NIM table
      function toggleCalculatedTable() {
        var button = $('#toggleCalculatedTableButton');
        var tableContainer = $('#calculatedTableContainer');

        if (tableContainer.is(':visible')) {
          tableContainer.hide();
          button.text('Display Extended Columns Table');
        } else {
          $.ajax({
            type: 'POST',
            url: '/get_bbs_extended',
            contentType: 'application/json',
            success: function (response) {
              if (response.data) {
                if ($.fn.DataTable.isDataTable('#calculatedTable')) {
                  $('#calculatedTable').DataTable().destroy();
                  $('#calculatedTable').empty();
                }

                $('#calculatedTable').html(response.data);

                // Row for filters
                $('#calculatedTable thead').append('<tr class="filters"></tr>');

                // Add inputs
                $('#calculatedTable thead tr:eq(0) th').each(function (index) {
                  // Check if it's a percentage column
                  if (index === 11) {
                    $('#calculatedTable .filters').append(`
                      <th style='width: 20%;'>
                        <select class="filter-operator">
                          <option value=">=">>=</option>
                          <option value=">">></option>
                          <option value="<="><=</option>
                          <option value="<"><</option>
                        </select>
                        <input type="number" class="filter-value" placeholder="Search..." style="width:100%">
                      </th>
                  `);
                  } else {
                    $('#calculatedTable .filters').append(
                      `<th><input type="text" placeholder="Search..." style="width:100%"/></th>`
                    );
                  }
                });

                let table = $('#calculatedTable').DataTable({
                  pageLength: 10,
                  lengthMenu: [
                    [10, 25, 50, 100],
                    [10, 25, 50, 100],
                  ],
                  responsive: true,
                  autoWidth: false,
                  searching: true,
                  ordering: true,
                  orderCellsTop: true,
                  fixedHeader: true,
                  dom: 'Blfrtip',
                  buttons: [
                    {
                      text: 'Export to Excel',
                      action: function () {
                        exportStyledTableToExcel('BBS Extended Columns Table');
                      },
                    },
                    {
                      type: 'button',
                      text: 'Toggle yellow cells filter',
                      action: function () {
                        toggleYellowFilter();
                      },
                    },
                  ],

                  // Yellow background if same as loaded year, semester, period
                  createdRow: function (row, data, dataIndex) {
                    let base = data[12];
                    let oneExtend = data[14];
                    let twoExtend = data[16];

                    const $cells = $('td', row);

                    if (base === window.stringToMatch) {
                      $cells.eq(12).css('background-color', 'yellow');
                      $cells.eq(12).addClass('data-yellow');
                    } else if (oneExtend === window.stringToMatch) {
                      $cells.eq(14).css('background-color', 'yellow');
                      $cells.eq(14).addClass('data-yellow');
                    } else if (twoExtend === window.stringToMatch) {
                      $cells.eq(16).css('background-color', 'yellow');
                      $cells.eq(16).addClass('data-yellow');
                    }

                    // Same thing, for the PDPT columns
                    let basePDPT = data[13];
                    let oneExtendPDPT = data[15];
                    let twoExtendPDPT = data[17];

                    if (basePDPT === window.stringToMatchPDPT) {
                      $cells.eq(13).css('background-color', 'yellow');
                      $cells.eq(13).addClass('data-yellow');
                    } else if (oneExtendPDPT === window.stringToMatchPDPT) {
                      $cells.eq(15).css('background-color', 'yellow');
                      $cells.eq(15).addClass('data-yellow');
                    } else if (twoExtendPDPT === window.stringToMatchPDPT) {
                      $cells.eq(17).css('background-color', 'yellow');
                      $cells.eq(17).addClass('data-yellow');
                    }
                  },

                  initComplete: function () {
                    this.api()
                      .columns()
                      .every(function () {
                        var column = this;
                        var index = column.index();

                        if (index === 11) return;
                        // Applying filters
                        $(
                          'input',
                          $('#calculatedTable .filters th').eq(column.index())
                        ).on('keyup change', function () {
                          column.search($(this).val()).draw();
                        });
                      });

                    $('#calculatedTable .filters').on(
                      'keyup change',
                      'input.filter-value, select.filter-operator',
                      function () {
                        table.draw();
                      }
                    );
                  },
                });

                tableContainer.show();
                button.text('Hide BBS Extended Columns Table');
              } else {
                alert(response.error);
              }
            },
            error: function () {
              alert('Error fetching BBS Extended Columns table.');
            },
          });
        }
      }

      // Show only yellow / show all toggle
      function toggleYellowFilter() {
        if (!window.yellowFilter) {
          window.yellowFilter = true;
        } else {
          window.yellowFilter = false;
        }

        // Refresh table
        $('#calculatedTable').DataTable().draw();
      }

      // Show the GROUPBY NIM table
      function toggleStudentListTable() {
        var button = $('#toggleStudentListButton');
        var tableContainer = $('#studentListContainer');

        // Color codings for each action
        const actionColorMap = {
          'Recommend for resignation': 'black',
          '1st Extension': 'yellow',
          '2nd Extension': 'orange',
          'Add to DO list': 'black',
          'DO depends on SCU in this period': 'orangered',
          'Recommend for resignation (confirm with operation)': 'fuchsia',
          '1st Extension (confirm with operation)': 'fuchsia',
          '2nd Extension (confirm with operation)': 'fuchsia',
          'Add to DO list (confirm with operation)': 'fuchsia',
          'DO depends on SCU in this period (confirm with operation)':
            'fuchsia',
          'Confirm with operation (PDPT)': 'fuchsia',
          'Confirm with operation (No PDPT)': 'fuchsia',
        };

        if (tableContainer.is(':visible')) {
          tableContainer.hide();
          button.text('Display Student List Table');
        } else {
          $.ajax({
            type: 'POST',
            url: '/get_bbs_student_list',
            contentType: 'application/json',
            success: function (response) {
              if (response.data) {
                if ($.fn.DataTable.isDataTable('#studentListTable')) {
                  $('#studentListTable').DataTable().destroy();
                  $('#studentListTable').empty();
                }

                $('#studentListTable').html(response.data);

                // Row for filters
                $('#studentListTable thead').append(
                  '<tr class="filters"></tr>'
                );

                $('#studentListTable thead tr:eq(0) th').each(function (index) {
                  // Check if it's a percentage column
                  if (index === 8) {
                    $('#studentListTable .filters').append(`
                      <th style='width: 20%;'>
                        <select class="filter-operator">
                          <option value=">=">>=</option>
                          <option value=">">></option>
                          <option value="<="><=</option>
                          <option value="<"><</option>
                        </select>
                        <input type="number" class="filter-value" placeholder="Search..." style="width:100%">
                      </th>
                  `);
                  } else {
                    $('#studentListTable .filters').append(
                      `<th><input type="text" placeholder="Search..." style="width:100%"/></th>`
                    );
                  }
                });

                let table = $('#studentListTable').DataTable({
                  pageLength: 10,
                  lengthMenu: [
                    [10, 25, 50, 100],
                    [10, 25, 50, 100],
                  ],
                  responsive: true,
                  autoWidth: false,
                  searching: true,
                  ordering: true,
                  orderCellsTop: true,
                  fixedHeader: true,
                  dom: 'Blfrtip',
                  buttons: [
                    {
                      text: 'Export to Excel',
                      action: function () {
                        exportStyledTableToExcel('BBS Extension Student List');
                      },
                    },
                  ],

                  // Colored background depending on the ACTION column
                  createdRow: function (row, data, dataIndex) {
                    let cellAction = data[15];

                    const $cells = $('td', row);

                    for (const action in actionColorMap) {
                      if (cellAction === action) {
                        let className = 'data-'.concat(actionColorMap[action]);
                        $cells
                          .eq(15)
                          .css('background-color', actionColorMap[action]);

                        // Turn the font white for black background
                        if (actionColorMap[action] === 'black') {
                          $cells.eq(15).css('color', 'white');
                        }
                        $cells.eq(15).addClass(className);
                      }
                    }

                    // Same as previous, all columns matching the dates are yellow
                    let base = data[9];
                    let oneExtend = data[11];
                    let twoExtend = data[13];

                    if (base === window.stringToMatch) {
                      $cells.eq(9).css('background-color', 'yellow');
                      $cells.eq(9).addClass('data-yellow');
                    } else if (oneExtend === window.stringToMatch) {
                      $cells.eq(11).css('background-color', 'yellow');
                      $cells.eq(11).addClass('data-yellow');
                    } else if (twoExtend === window.stringToMatch) {
                      $cells.eq(13).css('background-color', 'yellow');
                      $cells.eq(13).addClass('data-yellow');
                    }

                    let basePDPT = data[10];
                    let oneExtendPDPT = data[12];
                    let twoExtendPDPT = data[14];

                    if (basePDPT === window.stringToMatchPDPT) {
                      $cells.eq(10).css('background-color', 'yellow');
                      $cells.eq(10).addClass('data-yellow');
                    } else if (oneExtendPDPT === window.stringToMatchPDPT) {
                      $cells.eq(12).css('background-color', 'yellow');
                      $cells.eq(12).addClass('data-yellow');
                    } else if (twoExtendPDPT === window.stringToMatchPDPT) {
                      $cells.eq(14).css('background-color', 'yellow');
                      $cells.eq(14).addClass('data-yellow');
                    }
                  },

                  initComplete: function () {
                    this.api()
                      .columns()
                      .every(function () {
                        var column = this;
                        var index = column.index();
                        // Applying filters
                        if (index === 8) return;
                        $(
                          'input',
                          $('#studentListTable .filters th').eq(column.index())
                        ).on('keyup change', function () {
                          column.search($(this).val()).draw();
                        });
                      });

                    $('#studentListTable .filters').on(
                      'keyup change',
                      'input.filter-value, select.filter-operator',
                      function () {
                        table.draw();
                      }
                    );
                  },
                });

                tableContainer.show();
                button.text('Hide BBS Student List Table');
              } else {
                alert(response.error);
              }
            },
            error: function () {
              alert('Error fetching BBS Student List table.');
            },
          });
        }
      }

      // Exporting tables
      async function exportStyledTableToExcel(tableName) {
        // Create new workbook
        let workbook = new ExcelJS.Workbook();

        // Array for headers
        var headers = [];

        // Worksheet and workbook name
        var name = '';

        // Holds all columns for a certain table, so that filters and the empty spaces are not included in the workbook
        var columns = [];

        // Fetch the correct table, name the sheet appropriately, and get the table headers
        if (tableName === 'BBS Main Data Table') {
          var table = $('#dataFrameTable').DataTable();

          name = 'BBS Main Data Table';

          columns = [
            'EXTERNAL SYSTEM ID',
            'BINUSIAN ID',
            'FULL NAME',
            'GENDER',
            'CAMPUS',
            'ACAD PROG',
            'ACAD PLAN',
            'PROG STATUS',
            'ADMIT TERM',
            'INTAKE PDPT',
            'STUDENT TYPE',
            'TOTAL SCU (LAST TERM)',
          ];

          $('#dataFrameTable thead th').each(function () {
            // Get header text
            let text = $(this).text().trim();
            if (columns.includes(text)) {
              // If one of the table columns
              headers.push(text);
            }
          });
        } else if (tableName === 'BBS Extended Columns Table') {
          var table = $('#calculatedTable').DataTable();

          name = 'BBS Extended Columns Table';

          columns = [
            'EXTERNAL SYSTEM ID',
            'BINUSIAN ID',
            'FULL NAME',
            'GENDER',
            'CAMPUS',
            'ACAD PROG',
            'ACAD PLAN',
            'PROG STATUS',
            'ADMIT TERM',
            'INTAKE PDPT',
            'STUDENT TYPE',
            'TOTAL SCU (LAST TERM)',
            'BASE MAX STUDY PERIOD',
            'BASE MAX STUDY PERIOD (PDPT)',
            'MAX STUDY PERIOD 1 EXTEND',
            'MAX STUDY PERIOD 1 EXTEND (PDPT)',
            'MAX STUDY PERIOD 2 EXTEND',
            'MAX STUDY PERIOD 2 EXTEND (PDPT)',
          ];

          $('#calculatedTable thead th').each(function () {
            // Get header text
            let text = $(this).text().trim();
            if (columns.includes(text)) {
              // If one of the table columns
              headers.push(text);
            }
          });
        } else if (tableName === 'BBS Extension Student List') {
          var table = $('#studentListTable').DataTable();

          name = 'BBS List of Students for Extension';

          columns = [
            'EXTERNAL SYSTEM ID',
            'BINUSIAN ID',
            'FULL NAME',
            'ACAD PROG',
            'PROG STATUS',
            'ADMIT TERM',
            'INTAKE PDPT',
            'STUDENT TYPE',
            'TOTAL SCU (LAST TERM)',
            'BASE MAX STUDY PERIOD',
            'BASE MAX STUDY PERIOD (PDPT)',
            'MAX STUDY PERIOD 1 EXTEND',
            'MAX STUDY PERIOD 1 EXTEND (PDPT)',
            'MAX STUDY PERIOD 2 EXTEND',
            'MAX STUDY PERIOD 2 EXTEND (PDPT)',
            'ACTION',
          ];

          $('#studentListTable thead th').each(function () {
            let text = $(this).text().trim();
            if (columns.includes(text)) {
              headers.push(text);
            }
          });
        } else {
          alert('Table not found');
          return;
        }

        // Only get the visible rows
        let visibleRows = table.rows({ search: 'applied' }).nodes();

        // Add worksheet to workbook
        var worksheet = workbook.addWorksheet(name);

        // Add the headers to the worksheet, with borders and bolded
        worksheet.addRow(headers).eachCell((cell) => {
          cell.border = {
            top: { style: 'thin', color: { argb: '000000' } },
            left: { style: 'thin', color: { argb: '000000' } },
            bottom: { style: 'thin', color: { argb: '000000' } },
            right: { style: 'thin', color: { argb: '000000' } },
          };
          cell.font = { bold: true };
        });

        const classColorMap = {
          'data-yellow': 'FFFFFF00',
          'data-orange': 'FFFFA500',
          'data-orangered': 'FFFF4500',
          'data-fuchsia': 'FFFF00FF',
          'data-black': 'FF000000',
        };

        // Addings rows into the worksheet, then appropriate color cells
        $(visibleRows).each(function () {
          let rowData = [];
          let row = worksheet.addRow([]);

          $(this)
            .find('td')
            .each(function (colIndex) {
              // Get cell text
              let cellValue = $(this).text().trim();
              let cell = row.getCell(colIndex + 1);

              // Assign the value
              cell.value = cellValue;

              // Assign borders
              cell.border = {
                top: { style: 'thin', color: { argb: '000000' } },
                left: { style: 'thin', color: { argb: '000000' } },
                bottom: { style: 'thin', color: { argb: '000000' } },
                right: { style: 'thin', color: { argb: '000000' } },
              };

              for (const className in classColorMap) {
                if ($(this).hasClass(className)) {
                  cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: classColorMap[className] },
                  };

                  if (className === 'data-black') {
                    cell.font = {
                      color: { argb: 'FFFFFFFF' }, // White font color for visibility
                    };
                  }
                }
              }
            });
        });

        // Adjust each column's width to accomodate the longest value in that column
        worksheet.columns.forEach((column) => {
          // Initialize max length
          let maxLength = 0;

          // Loop throgh each cell, convert it to a string, and find the length of the longest value
          column.eachCell({ includeEmpty: true }, (cell) => {
            let cellText = cell.value ? cell.value.toString() : '';
            maxLength = Math.max(maxLength, cellText.length);
          });

          // Set the column width to the longest value with a bit of padding
          column.width = maxLength + 2;
        });

        // Save the file
        let buffer = await workbook.xlsx.writeBuffer();
        let blob = new Blob([buffer], {
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        });
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const loadedYear = parseInt($('#loadedYear').text().match(/\d{4}/)[0]);
        const loadedSemester = parseInt(
          $('#loadedSemester').text().match(/\d+/)[0]
        );
        const loadedPeriod = parseInt(
          $('#loadedPeriod').text().match(/\d+/)[0]
        );
        link.download = `${tableName} ${loadedYear}.${loadedSemester}${loadedPeriod}.xlsx`;
        link.click();
      }
    </script>
  </body>
</html>
